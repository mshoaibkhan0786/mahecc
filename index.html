<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIT Manipal - CSE Section CC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link id="favicon" rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%236d28d9'/%3E%3Cpath fill='white' d='M50 20 l25 15 v30 l-25 15 l-25 -15 v-30 z M50 38 l15 9 v18 l-15 9 l-15 -9 v-18 z'/%3E%3C/svg%3E">
    
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --bg-color-light: #f3f4f6;
            --text-color-light: #1f2937;
            --card-bg-light: #ffffff;
            --header-text-light: #0f172a;
            --accent-color-light: #6d28d9; /* Violet-700 */
            --border-color-light: #e5e7eb;
            --nav-bg-light: #ffffff;

            --bg-color-dark: #111827;
            --text-color-dark: #d1d5db;
            --card-bg-dark: #1f2937;
            --header-text-dark: #f9fafb;
            --accent-color-dark: #8b5cf6; /* Violet-500 */
            --border-color-dark: #374151;
            --nav-bg-dark: #1f2937;
        }

        .light {
            --bg-color: var(--bg-color-light);
            --text-color: var(--text-color-light);
            --card-bg: var(--card-bg-light);
            --header-text: var(--header-text-light);
            --accent-color: var(--accent-color-light);
            --border-color: var(--border-color-light);
            --nav-bg: var(--nav-bg-light);
        }

        .dark {
            --bg-color: var(--bg-color-dark);
            --text-color: var(--text-color-dark);
            --card-bg: var(--card-bg-dark);
            --header-text: var(--header-text-dark);
            --accent-color: var(--accent-color-dark);
            --border-color: var(--border-color-dark);
            --nav-bg: var(--nav-bg-dark);
        }

        html {
            scrollbar-gutter: stable;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .main-content-area {
            padding-top: 80px; /* Adjust based on nav height */
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .nav-link {
            font-weight: 600; /* Semibold */
            color: #6b7280; /* gray-500 */
        }
        .dark .nav-link {
            color: #9ca3af; /* gray-400 */
        }
        .nav-link.active {
            color: var(--accent-color);
        }
        .timetable-table, .calendar-table {
            border-collapse: separate;
            border-spacing: 0;
            min-width: 100%;
            background-color: var(--card-bg);
        }
        .timetable-table th, .timetable-table td, .calendar-table th, .calendar-table td {
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            text-align: center;
            font-size: 0.8rem;
        }
        @media (min-width: 640px) {
             .timetable-table th, .timetable-table td, .calendar-table th, .calendar-table td {
                 font-size: 0.9rem;
            }
        }
        .timetable-table th, .calendar-table th {
            background-color: var(--bg-color);
            color: var(--header-text);
            font-weight: 600;
        }
        .timetable-table .time-col {
            font-weight: 500;
            white-space: nowrap;
        }
        .timetable-table .lunch { background-color: #d1fae5; }
        .dark .timetable-table .lunch { background-color: #064e3b; }
        .timetable-table .break { background-color: #fee2e2; }
        .dark .timetable-table .break { background-color: #7f1d1d; }
        
        .calendar-table td.holiday { background-color: #fef9c3; }
        .dark .calendar-table td.holiday { background-color: #713f12; }
        .calendar-table td.exam { background-color: #ffe4e6; }
        .dark .calendar-table td.exam { background-color: #8c2a32; }

        .calendar-table td.event { background-color: #e0e7ff; }
        .dark .calendar-table td.event { background-color: #3730a3; }

        .prompt-suggestion-btn {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        .prompt-suggestion-btn:hover {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        #email-modal-content {
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }
        #email-modal.active #email-modal-content {
            transform: scale(1);
            opacity: 1;
        }
    </style>
</head>
<body class="antialiased">
    <div id="app">
        <!-- Header & Navigation -->
        <header class="bg-[var(--nav-bg)] shadow-md fixed w-full top-0 z-50 transition-colors duration-300">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 transition-transform duration-300 ease-in-out hover:-translate-y-0.5 cursor-pointer">
                             <svg class="h-8 w-8" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                 <rect width="100" height="100" rx="20" fill="var(--accent-color)"/>
                                 <path fill="white" d="M50 20 l25 15 v30 l-25 15 l-25 -15 v-30 z M50 38 l15 9 v18 l-15 9 l-15 -9 v-18 z"/>
                               </svg>
                        </div>
                        <div class="ml-4">
                            <!-- Desktop Nav -->
                            <div class="hidden md:flex items-baseline space-x-4">
                                <a href="#home" class="nav-link px-3 py-2 rounded-md text-sm transition-colors">Home</a>
                                <a href="#timetable" class="nav-link px-3 py-2 rounded-md text-sm transition-colors">Timetable</a>
                                <a href="#faculty" class="nav-link px-3 py-2 rounded-md text-sm transition-colors">Faculty</a>
                                <a href="#academic-calendar" class="nav-link px-3 py-2 rounded-md text-sm transition-colors">Calendar</a>
                                <a href="#study-material" class="nav-link px-3 py-2 rounded-md text-sm transition-colors">Study Material</a>
                                <a href="#restaurants" class="nav-link px-3 py-2 rounded-md text-sm transition-colors">Restaurants</a>
                                <a href="#gallery" class="nav-link px-3 py-2 rounded-md text-sm transition-colors">Gallery</a>
                            </div>
                            <!-- Mobile Visible Nav -->
                            <div class="flex md:hidden items-baseline space-x-1">
                                <a href="#home" class="nav-link px-2 py-2 rounded-md text-sm transition-colors">Home</a>
                                <a href="#timetable" class="nav-link px-2 py-2 rounded-md text-sm transition-colors">Timetable</a>
                                <a href="#faculty" class="nav-link px-2 py-2 rounded-md text-sm transition-colors">Faculty</a>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center">
                         <!-- Desktop Theme Switcher -->
                         <button class="theme-switcher-btn bg-[var(--bg-color)] p-2 rounded-full text-[var(--text-color)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--nav-bg)] focus:ring-[var(--accent-color)] hidden md:block">
                             <svg class="theme-icon-sun h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                             <svg class="theme-icon-moon h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                        </button>
                         <div class="ml-2 flex md:hidden">
                            <button id="mobile-menu-button" type="button" class="bg-[var(--card-bg)] inline-flex items-center justify-center p-2 rounded-md text-[var(--text-color)] hover:bg-[var(--bg-color)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--card-bg)] focus:ring-[var(--accent-color)]">
                                <span class="sr-only">Open main menu</span>
                                <svg id="menu-open-icon" class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                                <svg id="menu-close-icon" class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </nav>
            <!-- Mobile menu -->
            <div id="mobile-menu" class="md:hidden hidden">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <a href="#academic-calendar" class="nav-link block px-3 py-2 rounded-md text-base">Calendar</a>
                    <a href="#study-material" class="nav-link block px-3 py-2 rounded-md text-base">Study Material</a>
                    <a href="#restaurants" class="nav-link block px-3 py-2 rounded-md text-base">Restaurants</a>
                    <a href="#gallery" class="nav-link block px-3 py-2 rounded-md text-base">Gallery</a>
                </div>
                <div class="border-t border-[var(--border-color)] px-5 py-3">
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-base text-[var(--text-color)]">Toggle Theme</span>
                        <button class="theme-switcher-btn bg-[var(--bg-color)] p-2 rounded-full text-[var(--text-color)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--nav-bg)] focus:ring-[var(--accent-color)]">
                            <svg class="theme-icon-sun h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                            <svg class="theme-icon-moon h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content-area max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Home Page -->
            <section id="home" class="page">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold text-[var(--header-text)]">Dashboard</h1>
                    <p class="text-md mt-1">Deadlines and tasks for Section CC</p>
                </header>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <!-- Main Content -->
                    <div class="lg:col-span-2">
                        <div class="space-y-8">
                            <section id="quizzes">
                                <h2 class="text-2xl font-semibold mb-4 text-[var(--header-text)] flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                    Upcoming Quizzes
                                </h2>
                                <div class="space-y-4"></div>
                            </section>
                            <section id="assignments">
                                <h2 class="text-2xl font-semibold mb-4 text-[var(--header-text)] flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                                    Upcoming Assignments
                                </h2>
                                <div class="space-y-4"></div>
                            </section>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="lg:col-span-1">
                        <section id="notifications">
                            <h2 class="text-2xl font-semibold mb-4 text-[var(--header-text)] flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                                </svg>
                                Announcements
                            </h2>
                            <div class="space-y-3">
                                <!-- Notification cards will be injected here by JavaScript -->
                            </div>
                        </section>
                    </div>
                </div>
            </section>

            <!-- Timetable Page -->
            <section id="timetable" class="page">
                 <header class="mb-8">
                    <h1 class="text-3xl font-bold text-[var(--header-text)]">Class Timetable</h1>
                    <p class="text-md mt-1">July - Nov 2025 | Semester I, Section CC (Stream: CSE)</p>
                </header>
                 <div class="overflow-x-auto bg-[var(--card-bg)] rounded-lg shadow-md">
                    <table class="timetable-table">
                        <thead>
                            <tr>
                                <th>Day</th>
                                <th>08:00 - 09:00</th>
                                <th>09:00 - 10:00</th>
                                <th>10:00 - 10:30</th>
                                <th>10:30 - 11:30</th>
                                <th>11:30 - 12:30</th>
                                <th>12:30 - 01:00</th>
                                <th>01:00 - 02:00</th>
                                <th>02:00 - 03:00</th>
                                <th>03:00 - 03:30</th>
                                <th>03:30 - 04:30</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="time-col">MON</td>
                                <td colspan="2">EVS (P)<br>(SGS)</td>
                                <td class="break">Break</td>
                                <td>MATHS<br>(SME)</td>
                                <td></td>
                                <td class="lunch" rowspan="6">Lunch Break</td>
                                <td></td>
                                <td colspan="3">CAEG LAB (2:00 - 5:00 PM)<br>[CC1: AB1 328; CC2: AB 331]</td>
                            </tr>
                            <tr>
                                <td class="time-col">TUE</td>
                                <td colspan="5"></td>
                                <td>EMSB<br>(BS)</td>
                                <td>FEE<br>(AN)</td>
                                <td class="break">Break</td>
                                <td>CHEM<br>(SA)</td>
                            </tr>
                             <tr>
                                <td class="time-col">WED</td>
                                <td>MATHS<br>(SME)</td>
                                <td>EMSB<br>(BS)</td>
                                <td class="break">Break</td>
                                <td>FEE<br>(AN)</td>
                                <td>PPS<br>(TS)</td>
                                <td colspan="4"></td>
                            </tr>
                             <tr>
                                <td class="time-col">THU</td>
                                <td colspan="5"></td>
                                <td>CHEM<br>(SA)</td>
                                <td>PPS<br>(TS)</td>
                                <td class="break">Break</td>
                                <td>EVS (L)<br>(SGS)</td>
                            </tr>
                             <tr>
                                <td class="time-col">FRI</td>
                                <td>FEE<br>(AN)</td>
                                <td>CHEM<br>(SA)</td>
                                <td class="break">Break</td>
                                <td>PPS<br>(TS)</td>
                                <td>MATHS<br>(SME)</td>
                                <td colspan="4"></td>
                            </tr>
                             <tr>
                                <td class="time-col">SAT</td>
                                <td></td>
                                <td colspan="3">PPS LAB (9:00 - 11:30 AM)<br>(AB1 129)</td>
                                <td></td>
                                <td></td>
                                <td>MATHS<br>(SME)</td>
                                <td class="break">Break</td>
                                <td>EMSB<br>(BS)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                 <div class="mt-6 overflow-x-auto bg-[var(--card-bg)] rounded-lg shadow-md">
                        <table class="timetable-table">
                            <thead>
                                <tr>
                                    <th colspan="3">Mandatory Learning Courses</th>
                                </tr>
                                <tr>
                                    <th>Course</th>
                                    <th>Day</th>
                                    <th>Time & Mode</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>CPI</td>
                                    <td>FRIDAY</td>
                                    <td>5:00 - 6:30 PM (ONLINE - MS TEAMS)</td>
                                </tr>
                            </tbody>
                        </table>
                </div>
            </section>

            <!-- Faculty Page -->
            <section id="faculty" class="page">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold text-[var(--header-text)]">Faculty Details</h1>
                    <p class="text-md mt-1">Contact information for Section CC faculty.</p>
                </header>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Faculty cards will be injected here -->
                </div>
            </section>
            
            <!-- Academic Calendar Page -->
            <section id="academic-calendar" class="page">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold text-[var(--header-text)]">Academic Calendar 2025-26</h1>
                    <p class="text-md mt-1">Official calendar for Odd and Even semesters.</p>
                </header>
                <div class="space-y-12">
                    <div>
                        <h2 class="text-2xl font-semibold mb-4 text-[var(--header-text)]">Odd Semester (July - December 2025)</h2>
                        <div class="overflow-x-auto bg-[var(--card-bg)] rounded-lg shadow-md">
                            <table class="calendar-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>July</th>
                                        <th>August</th>
                                        <th>September</th>
                                        <th>October</th>
                                        <th>November</th>
                                        <th>December</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr> <td>1-8</td> <td></td> <td></td> <td></td> <td>1: Maha Navami</td> <td>1: Karnataka Rajyotsava</td> <td>1: Winter Labs Start</td> </tr>
                                    <tr> <td>9-16</td> <td>11-12: Doc Verification</td> <td class="holiday">15: Independence Day<br>16: Holiday (Third Sat)</td> <td>12-13: Mid-term Exam</td> <td class="event">10: Tech Tatva</td> <td class="holiday">15: Holiday (Third Sat)</td> <td>13: Exam Results</td> </tr>
                                    <tr> <td>17-24</td> <td>19: Holiday (Third Sat)<br>22: First Class Committee</td> <td></td> <td class="holiday">20: Holiday (Third Sat)</td> <td class="holiday">18: Holiday (Third Sat)<br>20: Deepavali</td> <td>17: End Sem Exams Start</td> <td>19: Makeup Exams Start<br><span class="holiday">20: Holiday (Third Sat)</span></td> </tr>
                                    <tr> <td>25-31</td> <td>25: Friday Timetable</td> <td></td> <td></td> <td></td> <td class="exam">29: End Sem Exam End</td> <td>25: Christmas</td> </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-semibold mb-4 text-[var(--header-text)]">Even Semester (January - May 2026)</h2>
                        <div class="overflow-x-auto bg-[var(--card-bg)] rounded-lg shadow-md">
                           <table class="calendar-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>January</th>
                                        <th>February</th>
                                        <th>March</th>
                                        <th>April</th>
                                        <th>May</th>
                                        <th>June</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr> <td>1-8</td> <td></td> <td>6: First Class Committee</td> <td>4: Holi</td> <td class="holiday">1: May Day</td> <td>2: End Sem Exam Start</td> <td>1: End Sem Results</td> </tr>
                                    <tr> <td>9-16</td> <td></td> <td></td> <td>6-7: Mid-term Exam</td> <td>9-11: UTSAV</td> <td class="holiday">16: Holiday (Third Sat)</td> <td>8: Makeup Exams Start</td> </tr>
                                    <tr> <td>17-24</td> <td class="holiday">17: Holiday (Third Sat)</td> <td class="holiday">21: Holiday (Third Sat)</td> <td>10-11: Mid-term Exam<br><span class="holiday">21: Holiday (Third Sat)</span></td> <td class="holiday">18: Holiday (Third Sat)</td> <td class="exam">19: Last working Day</td> <td class="holiday">20: Holiday (Third Sat)</td> </tr>
                                    <tr> <td>25-31</td> <td class="holiday">26: Republic Day</td> <td></td> <td class="event">26-27: Revels</td> <td>30: Finalizing IA marks</td> <td></td> <td></td> </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Study Material Page -->
            <section id="study-material" class="page">
                 <header class="mb-8">
                    <h1 class="text-3xl font-bold text-[var(--header-text)]">Study Material</h1>
                </header>
                <!-- Gemini AI Study Helper -->
                <div id="study-helper" class="bg-[var(--card-bg)] rounded-lg shadow-md border border-[var(--border-color)] p-4 sm:p-6">
                    <div class="flex items-center gap-4 mb-4">
                        <h2 class="text-2xl font-bold text-[var(--header-text)]">âœ¨ AI Study Helper</h2>
                    </div>
                    <p class="mb-4 text-sm text-gray-600 dark:text-gray-400">Ask me anything about your subjects! I can help explain concepts, give you practice problems, or summarize topics.</p>
            
                    <!-- Chat messages display -->
                        <div id="chat-messages" class="h-96 overflow-y-auto p-4 bg-[var(--bg-color)] rounded-lg mb-4 space-y-4">
                        <!-- Example AI message -->
                        <div class="flex items-start gap-3">
                            <span class="flex-shrink-0 h-8 w-8 rounded-full bg-[var(--accent-color)]/20 flex items-center justify-center text-[var(--accent-color)] font-bold">AI</span>
                            <div class="bg-[var(--card-bg)] p-3 rounded-lg border border-[var(--border-color)]">
                                <p class="text-sm">Hi there! I'm Circute, your AI study helper. How can I help you study today? Feel free to ask a question about any of your subjects.</p>
                            </div>
                        </div>
                    </div>
            
                    <!-- Prompt suggestions -->
                    <div class="mb-4 flex flex-wrap gap-2">
                         <button class="prompt-suggestion-btn">Explain recursion in PPS</button>
                         <button class="prompt-suggestion-btn">Summarize Newton's Laws</button>
                         <button class="prompt-suggestion-btn">Practice problem for differentiation</button>
                    </div>
            
                    <!-- Chat input -->
                    <div class="flex gap-2">
                        <input type="text" id="chat-input" placeholder="Type your question here..." class="flex-grow bg-[var(--bg-color)] border border-[var(--border-color)] rounded-lg p-3 focus:ring-2 focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)] transition duration-200">
                        <button id="send-chat-btn" class="bg-[var(--accent-color)] hover:opacity-90 text-white font-bold py-3 px-5 rounded-lg transition-transform transform hover:scale-105 duration-300 flex items-center justify-center">
                            Send
                        </button>
                    </div>
                    <div id="chat-loader" class="hidden text-center py-2">
                        <p class="text-sm text-gray-500 animate-pulse">Circute is thinking...</p>
                    </div>
                </div>
            </section>

            <!-- Restaurants Page -->
            <section id="restaurants" class="page">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold text-[var(--header-text)]">Nearby Restaurants</h1>
                    <p class="text-md mt-1">Contact list for local food joints.</p>
                </header>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Restaurant cards will be injected here -->
                </div>
            </section>

            <!-- Gallery Page -->
            <section id="gallery" class="page">
                 <header class="mb-8">
                    <h1 class="text-3xl font-bold text-[var(--header-text)]">Class Gallery</h1>
                    <p class="text-md mt-1">Bas yaadein hi reh jaegi</p>
                </header>
                <div class="flex items-center justify-center h-96 bg-[var(--card-bg)] rounded-lg shadow-md border border-[var(--border-color)]">
                    <h2 class="text-5xl font-bold text-[var(--accent-color)] opacity-75 animate-pulse">Coming Soon</h2>
                </div>
            </section>

        </main>

        <footer class="text-center py-6 border-t border-[var(--border-color)] mt-12">
            <p class="text-sm text-gray-400 dark:text-gray-500 opacity-75">Built by Mohammad Shoaib Khan</p>
        </footer>

        <!-- Email Composer Modal -->
        <div id="email-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
            <div id="email-modal-content" class="bg-[var(--card-bg)] rounded-lg shadow-xl w-11/12 md:max-w-2xl mx-auto border border-[var(--border-color)] flex flex-col max-h-[90vh]">
                <!-- Modal Header -->
                <div class="flex-shrink-0 p-5 border-b border-[var(--border-color)]">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-[var(--header-text)]">Compose Email with Circute</h2>
                        <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                </div>

                <!-- Scrollable Modal Body -->
                <div class="overflow-y-auto p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium">To:</label>
                        <input type="hidden" id="modal-email-to-value">
                        <div class="mt-1 block w-full bg-[var(--bg-color)] border border-[var(--border-color)] rounded-lg p-3 break-all">
                            <span id="modal-email-to-display" class="text-sm"></span>
                        </div>
                    </div>
                    <div>
                        <label for="modal-email-subject" class="block text-sm font-medium">Subject:</label>
                        <input type="text" id="modal-email-subject" placeholder="e.g., Question about Assignment 1" class="mt-1 block w-full bg-[var(--bg-color)] border border-[var(--border-color)] rounded-lg p-3 focus:ring-2 focus:ring-[var(--accent-color)]">
                    </div>
                    <div>
                        <label for="modal-email-prompt" class="block text-sm font-medium">What is this email about? (Brief prompt)</label>
                        <textarea id="modal-email-prompt" rows="3" placeholder="e.g., I need to request an extension for the assignment due to a medical issue." class="mt-1 block w-full bg-[var(--bg-color)] border border-[var(--border-color)] rounded-lg p-3 focus:ring-2 focus:ring-[var(--accent-color)]"></textarea>
                    </div>
                    <div>
                        <label for="modal-email-from" class="block text-sm font-medium">Your Name:</label>
                        <input type="text" id="modal-email-from" placeholder="Enter your full name" class="mt-1 block w-full bg-[var(--bg-color)] border border-[var(--border-color)] rounded-lg p-3 focus:ring-2 focus:ring-[var(--accent-color)]">
                    </div>
                    <div>
                        <label for="modal-email-regno" class="block text-sm font-medium">Registration No.:</label>
                        <input type="text" id="modal-email-regno" placeholder="e.g., 251090051634" class="mt-1 block w-full bg-[var(--bg-color)] border border-[var(--border-color)] rounded-lg p-3 focus:ring-2 focus:ring-[var(--accent-color)]">
                    </div>
                    <button id="modal-generate-email-btn" class="w-full bg-[var(--accent-color)] hover:opacity-90 text-white font-bold py-3 px-5 rounded-lg transition-transform transform hover:scale-105 duration-300 flex items-center justify-center">
                        Generate Email Body
                    </button>
                    <div id="modal-email-loader" class="hidden text-center py-2">
                        <p class="text-sm text-gray-500 animate-pulse">Drafting email...</p>
                    </div>
                    <div>
                        <label for="modal-email-body" class="block text-sm font-medium">Generated Email:</label>
                        <div class="relative">
                            <textarea id="modal-email-body" rows="8" class="mt-1 block w-full bg-[var(--bg-color)] border border-[var(--border-color)] rounded-lg p-3 pr-12" readonly></textarea>
                            <button id="copy-email-btn" title="Copy to clipboard" class="absolute top-2 right-2 p-2 rounded-md bg-[var(--bg-color)] hover:bg-[var(--border-color)] text-[var(--text-color)]">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            </button>
                        </div>
                         <p id="copy-confirm" class="text-xs text-green-600 mt-1 hidden">Copied!</p>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="flex-shrink-0 p-4 bg-[var(--bg-color)]/80 backdrop-blur-sm border-t border-[var(--border-color)] rounded-b-lg">
                     <button id="send-email-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center text-base">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009.894 15V4.106A1 1 0 0010.894 2.553z" />
                            <path d="M10.106 4.106l5.092 1.456a1 1 0 001.17-1.408l-7-14a1 1 0 00-1.788 0l-1.06 2.121a1 1 0 001.788 1.06l1.06-2.12z" />
                        </svg>
                        Send via Email App
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- SUPABASE SETUP ---
            let supabaseClient;
            try {
                const SUPABASE_URL = 'https://syvpeftawfakdiebueji.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5dnBlZnRhd2Zha2RpZWJ1ZWppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMjMyNDcsImV4cCI6MjA3NTU5OTI0N30.RSR3fp-ooPgSxwCKmMb-Xt2pTrb2cO8w5VJg9bZxaiY';
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } catch (e) {
                console.error("Supabase not available or initialization failed:", e);
            }


            // --- DATA (Static) ---
             const faculty = [
                { name: 'Sandeep Sir', subject: 'EVS', contact: '+91 9164489836', cabin: 'AB2 Basement', email: 'sandeep.gs@manipal.edu' },
                { name: 'Shobha Ma\'am', subject: 'Maths', contact: '+91 9591474101', cabin: 'N/A', email: 'shobha.me@manipal.edu' },
                { name: 'Sowmya Ma\'am', subject: 'Chem', contact: '+91 9686781587', cabin: 'N/A', email: 'sowmya.achar@manipal.edu' },
                { name: 'Anandh Sir', subject: 'FEE', contact: '+91 9787934850', cabin: 'N/A', email: 'anandh.n@manipal.edu' },
                { name: 'Bhagyashree Ma\'am', subject: 'EMSB', contact: '+91 8277511547', cabin: 'AB2 Basement', email: 'bhagyalaxmi.kh@manipal.edu' },
                { name: 'Sujithra Ma\'am', subject: 'PPS', contact: '+91 9047756324', cabin: 'AB5', email: 't.sujithra@manipal.edu' },
            ];
            const restaurants = [
                { name: 'Taco House', contact: '+91 7795815315' },
                { name: 'Hungry House', contact: '+91 9820243177' },
                { name: 'MFC', contact: '+91 7338334970' },
                { name: 'Hit & Run', contact: '+91 7406330088' },
                { name: 'Janani Canteen', contact: '+91 8660138488' },
                { name: 'Dollar Cafe', contact: '+91 8105306109' },
                { name: 'Kamath Cafe', contact: '+91 8217044886' },
                { name: 'Aditya Mess', contact: '+91 7483644586' },
                { name: 'Apoorva Mess', contact: '+91 9108888320' },
                { name: 'FC 2', contact: '+91 8861953102' },
                { name: 'Poornima', contact: '+91 7090641985' },
                { name: 'Nom Nom cafe', contact: '+91 7619422026' },
                { name: 'Ashraya', contact: '+91 6361201519' },
            ];
            
            const today = new Date();

            // --- THEME SWITCHER ---
            const themeSwitchers = document.querySelectorAll('.theme-switcher-btn');
            const allSunIcons = document.querySelectorAll('.theme-icon-sun');
            const allMoonIcons = document.querySelectorAll('.theme-icon-moon');

            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    document.documentElement.classList.remove('light');
                    document.documentElement.classList.add('dark');
                    allSunIcons.forEach(icon => icon.classList.add('hidden'));
                    allMoonIcons.forEach(icon => icon.classList.remove('hidden'));
                } else {
                    document.documentElement.classList.remove('dark');
                    document.documentElement.classList.add('light');
                    allSunIcons.forEach(icon => icon.classList.remove('hidden'));
                    allMoonIcons.forEach(icon => icon.classList.add('hidden'));
                }
            };
            
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);

            themeSwitchers.forEach(button => {
                button.addEventListener('click', () => {
                    const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                });
            });
            
            // --- ROUTING / PAGE NAVIGATION ---
            const pages = document.querySelectorAll('.page');
            const navLinks = document.querySelectorAll('.nav-link');
            const mobileMenu = document.getElementById('mobile-menu');
            const mobileMenuBtn = document.getElementById('mobile-menu-button');
            const menuOpenIcon = document.getElementById('menu-open-icon');
            const menuCloseIcon = document.getElementById('menu-close-icon');

            const showPage = (hash) => {
                const pageId = hash ? hash.substring(1) : 'home';
                pages.forEach(page => {
                    page.classList.toggle('active', page.id === pageId);
                });
                navLinks.forEach(link => {
                    link.classList.toggle('active', link.hash === hash || (hash === '' && link.hash === '#home'));
                });
                window.scrollTo(0, 0); // Scroll to top on page change
                // Always close menu on navigation
                mobileMenu.classList.add('hidden');
                menuOpenIcon.classList.remove('hidden');
                menuCloseIcon.classList.add('hidden');
            };

            navLinks.forEach(link => link.addEventListener('click', (e) => showPage(e.currentTarget.hash)));
            
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                menuOpenIcon.classList.toggle('hidden');
                menuCloseIcon.classList.toggle('hidden');
            });

            window.addEventListener('hashchange', () => showPage(window.location.hash));
            showPage(window.location.hash || '#home');


            // --- DYNAMIC CONTENT RENDERING ---
            const renderDeadlineCards = async () => {
                const assignmentsContainer = document.querySelector('#assignments .space-y-4');
                const quizzesContainer = document.querySelector('#quizzes .space-y-4');
                
                if (!supabaseClient) {
                    const errorHtml = `<div class="bg-red-100 dark:bg-red-900/20 border border-red-400 text-red-700 dark:text-red-300 px-4 py-3 rounded-lg" role="alert"><p>Supabase client not initialized. Cannot load deadlines.</p></div>`;
                    assignmentsContainer.innerHTML = errorHtml;
                    quizzesContainer.innerHTML = errorHtml;
                    return;
                }

                // Initial loading state
                const loadingHtml = `<div class="bg-[var(--card-bg)] rounded-lg p-4 text-center border border-[var(--border-color)]"><p class="text-sm text-gray-500 dark:text-gray-400">Loading...</p></div>`;
                assignmentsContainer.innerHTML = loadingHtml;
                quizzesContainer.innerHTML = loadingHtml;

                const getDaysRemaining = (dueDate) => {
                    const due = new Date(dueDate);
                    due.setHours(23, 59, 59, 999);
                    const diffTime = due.getTime() - today.getTime();
                    return Math.floor(diffTime / (1000 * 60 * 60 * 24));
                };

                const createCard = (item) => {
                    let daysText, daysColorClass, formattedDate;

                    if (item.duedate) {
                        const daysLeft = getDaysRemaining(item.duedate);
                        if (daysLeft < 0) { 
                            daysText = 'Overdue'; 
                            daysColorClass = 'bg-red-500 text-white'; 
                        } else if (daysLeft === 0) { 
                            daysText = 'Due Today'; 
                            daysColorClass = 'bg-red-500 text-white'; 
                        } else if (daysLeft === 1) { 
                            daysText = 'Due Tomorrow'; 
                            daysColorClass = 'bg-orange-500 text-white'; 
                        } else { 
                            daysText = `${daysLeft} days left`; 
                            daysColorClass = 'bg-green-600 text-white'; 
                        }
                        formattedDate = new Date(item.duedate).toLocaleString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
                    } else {
                        daysText = 'No Date';
                        daysColorClass = 'bg-gray-400 text-white';
                        formattedDate = 'N/A';
                    }
                    
                    return `
                        <div class="bg-[var(--card-bg)] rounded-lg p-4 shadow-md border border-[var(--border-color)]">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-lg text-[var(--header-text)]">${item.subject || 'N/A'}</p>
                                    <p class="text-md">${item.title || 'No Title'}</p>
                                </div>
                                <span class="text-xs font-semibold px-3 py-1 rounded-full ${daysColorClass}">${daysText}</span>
                            </div>
                            <p class="text-sm mt-3 opacity-80">Due: ${formattedDate}</p>
                        </div>`;
                };

                try {
                    // Fetch both assignments and quizzes
                    const { data: assignments, error: assignmentsError } = await supabaseClient.from('assignments').select('*');
                    if (assignmentsError) throw assignmentsError;

                    const { data: quizzes, error: quizzesError } = await supabaseClient.from('quizzes').select('*');
                    if (quizzesError) throw quizzesError;

                    // Clear containers before rendering
                    assignmentsContainer.innerHTML = '';
                    quizzesContainer.innerHTML = '';

                    // Sort assignments: by due date, with nulls last
                    const sortedAssignments = (assignments || []).sort((a, b) => {
                        if (!a.duedate) return 1;
                        if (!b.duedate) return -1;
                        return new Date(a.duedate) - new Date(b.duedate);
                    });

                    if (sortedAssignments.length > 0) {
                        sortedAssignments.forEach(ass => {
                            assignmentsContainer.innerHTML += createCard(ass);
                        });
                    } else {
                        assignmentsContainer.innerHTML = `<div class="bg-[var(--card-bg)] rounded-lg p-4 text-center border border-[var(--border-color)] flex items-center justify-center h-48"><h2 class="text-2xl font-bold text-[var(--accent-color)] opacity-75">No Upcoming Assignments</h2></div>`;
                    }
                    
                    // Sort quizzes: by due date, with nulls last
                    const sortedQuizzes = (quizzes || []).sort((a, b) => {
                        if (!a.duedate) return 1;
                        if (!b.duedate) return -1;
                        return new Date(a.duedate) - new Date(b.duedate);
                    });

                    if (sortedQuizzes.length > 0) {
                        sortedQuizzes.forEach(quiz => {
                            quizzesContainer.innerHTML += createCard(quiz);
                        });
                    } else {
                        quizzesContainer.innerHTML = `<div class="bg-[var(--card-bg)] rounded-lg p-4 text-center border border-[var(--border-color)] flex items-center justify-center h-48"><h2 class="text-2xl font-bold text-[var(--accent-color)] opacity-75">No Upcoming Quizzes</h2></div>`;
                    }

                } catch(error) {
                    console.error("Error fetching deadline data:", error);
                    const errorHtml = `<div class="bg-red-100 dark:bg-red-900/20 border border-red-400 text-red-700 dark:text-red-300 px-4 py-3 rounded-lg" role="alert"><p>Could not load data. Check RLS policies.</p></div>`;
                    assignmentsContainer.innerHTML = errorHtml;
                    quizzesContainer.innerHTML = errorHtml;
                }
            };

            const renderFacultyCards = () => {
                const container = document.querySelector('#faculty .grid');
                container.innerHTML = '';
                faculty.forEach(f => {
                    const emailButtonHtml = f.email !== 'N/A' ? `
                        <div class="mt-4 pt-4 border-t border-[var(--border-color)]">
                            <button data-faculty-name="${f.name}" data-faculty-email="${f.email}" class="compose-email-btn w-full text-center bg-[var(--accent-color)]/10 text-[var(--accent-color)] font-semibold py-2 px-4 rounded-lg hover:bg-[var(--accent-color)] hover:text-white transition-colors duration-300 text-sm">
                                Compose Email
                            </button>
                        </div>
                    ` : '';

                    container.innerHTML += `
                        <div class="bg-[var(--card-bg)] rounded-lg p-5 shadow-md border border-[var(--border-color)] flex flex-col">
                            <h3 class="text-xl font-bold text-[var(--header-text)]">${f.name}</h3>
                            <p class="text-[var(--accent-color)] font-semibold">${f.subject}</p>
                            <div class="mt-4 space-y-2 text-sm flex-grow">
                                <a href="tel:${f.contact}" class="flex items-center text-[var(--accent-color)] hover:underline">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" /></svg>
                                    ${f.contact}
                                </a>
                                <p class="flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                                    ${f.cabin}
                                </p>
                                <a href="${f.email !== 'N/A' ? 'mailto:' + f.email : '#'}" class="flex items-center ${f.email !== 'N/A' ? 'hover:underline text-[var(--accent-color)]' : 'cursor-default'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg>
                                    ${f.email}
                                </a>
                            </div>
                            ${emailButtonHtml}
                        </div>
                    `;
                });
            };

            const renderRestaurantCards = () => {
                const container = document.querySelector('#restaurants .grid');
                if (!container) return;
                container.innerHTML = '';
                restaurants.forEach(r => {
                    container.innerHTML += `
                        <div class="bg-[var(--card-bg)] rounded-lg p-5 shadow-md border border-[var(--border-color)]">
                            <h3 class="text-xl font-bold text-[var(--header-text)]">${r.name}</h3>
                            <div class="mt-2 text-sm">
                                <a href="tel:${r.contact}" class="flex items-center text-[var(--accent-color)] hover:underline">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" /></svg>
                                    ${r.contact}
                                </a>
                            </div>
                        </div>
                    `;
                });
            };

            const timeAgo = (dateString) => {
                const date = new Date(dateString);
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " years ago";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " months ago";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " days ago";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " hours ago";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " minutes ago";
                return "Just now";
            };

            const renderAnnouncements = async () => {
                const container = document.querySelector('#notifications .space-y-3');
                if (!container || !supabaseClient) {
                     container.innerHTML = `<div class="bg-red-100 dark:bg-red-900/20 border border-red-400 text-red-700 dark:text-red-300 px-4 py-3 rounded-lg" role="alert"><p>Supabase client not initialized.</p></div>`;
                    return;
                };
                
                container.innerHTML = `<div class="bg-[var(--card-bg)] rounded-lg p-4 text-center border border-[var(--border-color)]"><p class="text-sm text-gray-500 dark:text-gray-400">Loading...</p></div>`;

                const handleUpdates = (data) => {
                    if (!data || data.length === 0) {
                        container.innerHTML = `
                            <div class="bg-[var(--card-bg)] rounded-lg p-4 text-center border border-[var(--border-color)] flex items-center justify-center h-48">
                                <h2 class="text-2xl font-bold text-[var(--accent-color)] opacity-75">No Announcement</h2>
                            </div>`;
                        return;
                    }
                    
                    container.innerHTML = '';
                    data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).forEach(ann => {
                        const postTime = timeAgo(ann.created_at);
                        container.innerHTML += `
                            <div class="bg-[var(--card-bg)] rounded-lg p-4 shadow-sm border border-[var(--border-color)] flex items-start space-x-3">
                                <div class="flex-shrink-0">
                                    <div class="h-8 w-8 rounded-full bg-[var(--accent-color)]/20 flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-2.236 9.168-5.5" />
                                        </svg>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-sm">${ann.text}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${postTime}</p>
                                </div>
                            </div>
                        `;
                    });
                };
                
                // Fetch initial data
                const { data, error } = await supabaseClient.from('announcements').select('*');
                if (error) {
                       console.error("Supabase error:", error);
                       container.innerHTML = `<div class="bg-red-100 dark:bg-red-900/20 border border-red-400 text-red-700 dark:text-red-300 px-4 py-3 rounded-lg" role="alert"><p>Could not load announcements. Check RLS policies.</p></div>`;
                } else {
                       handleUpdates(data);
                }

                // Listen for real-time changes
                supabaseClient.channel('custom-all-channel')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'announcements' }, async (payload) => {
                         const { data } = await supabaseClient.from('announcements').select('*');
                         handleUpdates(data);
                    })
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'quizzes' }, (payload) => {
                        renderDeadlineCards();
                    })
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'assignments' }, (payload) => {
                        renderDeadlineCards();
                    })
                    .subscribe();
            };

            // --- GEMINI API FEATURES ---

            const callGeminiAPI = async (userQuery, systemPrompt, retries = 3, delay = 1000) => {
                // The URL now points to your Supabase Edge Function.
                const supabaseFunctionUrl = 'https://syvpeftawfakdiebueji.supabase.co/functions/v1/call-gemini';
                const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5dnBlZnRhd2Zha2RpZWJ1ZWppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMjMyNDcsImV4cCI6MjA3NTU5OTI0N30.RSR3fp-ooPgSxwCKmMb-Xt2pTrb2cO8w5VJg9bZxaiY';

                const payload = { userQuery, systemPrompt };

                try {
                    const response = await fetch(supabaseFunctionUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': supabaseAnonKey, // Correct Supabase anon key
                            'Authorization': `Bearer ${supabaseAnonKey}` // Standard authorization header
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retries > 0) {
                            await new Promise(res => setTimeout(res, delay));
                            return callGeminiAPI(userQuery, systemPrompt, retries - 1, delay * 2);
                        }
                        const errorData = await response.json();
                        throw new Error(`API request failed with status ${response.status}: ${errorData.error || 'Unknown error'}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text;
                    } else if (result.error) {
                         throw new Error(`Error from Supabase Function: ${result.error}`);
                    }
                    else {
                        // Check for a different error structure from Gemini through the function
                        if(result.error && result.error.message) {
                            throw new Error(`Error from Gemini API: ${result.error.message}`);
                        }
                        throw new Error("Invalid response structure from API.");
                    }
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    return `Sorry, an error occurred: ${error.message}`;
                }
            };

            // --- AI Study Helper Logic ---
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendChatBtn = document.getElementById('send-chat-btn');
            const chatLoader = document.getElementById('chat-loader');
            const promptSuggestionBtns = document.querySelectorAll('.prompt-suggestion-btn');

            const addMessageToChat = (message, sender) => {
                const messageDiv = document.createElement('div');
                let content;
                if (sender === 'user') {
                    content = `
                        <div class="flex items-start gap-3 justify-end">
                            <div class="bg-blue-600 text-white p-3 rounded-lg">
                                <p class="text-sm">${message}</p>
                            </div>
                            <span class="flex-shrink-0 h-8 w-8 rounded-full bg-gray-300 flex items-center justify-center font-bold">You</span>
                        </div>
                    `;
                } else { // AI
                    content = `
                        <div class="flex items-start gap-3">
                            <span class="flex-shrink-0 h-8 w-8 rounded-full bg-[var(--accent-color)]/20 flex items-center justify-center text-[var(--accent-color)] font-bold">AI</span>
                            <div class="bg-[var(--card-bg)] p-3 rounded-lg border border-[var(--border-color)]">
                                <p class="text-sm">${message}</p>
                            </div>
                        </div>
                    `;
                }
                messageDiv.innerHTML = content;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };

            const handleSendMessage = async () => {
                const userQuery = chatInput.value.trim();
                if (!userQuery) return;

                addMessageToChat(userQuery, 'user');
                chatInput.value = '';
                chatLoader.classList.remove('hidden');
                sendChatBtn.disabled = true;

                const systemPrompt = "You are a friendly and encouraging AI tutor for first-year engineering students at MIT Manipal. Your name is 'Circute'. Your goal is to help students understand complex topics by breaking them down into simple, easy-to-understand explanations. Avoid overly technical jargon. Use analogies and real-world examples where possible. Keep your responses concise and focused on the student's question. When asked for practice problems, provide one and then offer to provide the solution.";
                const aiResponse = await callGeminiAPI(userQuery, systemPrompt);

                addMessageToChat(aiResponse, 'ai');
                chatLoader.classList.add('hidden');
                sendChatBtn.disabled = false;
                chatInput.focus();
            };

            sendChatBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSendMessage();
                }
            });
            promptSuggestionBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    chatInput.value = btn.textContent;
                    handleSendMessage();
                });
            });

             // --- AI Email Modal Logic ---
            const emailModal = document.getElementById('email-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const modalEmailToDisplay = document.getElementById('modal-email-to-display');
            const modalEmailToValue = document.getElementById('modal-email-to-value');
            const modalEmailFrom = document.getElementById('modal-email-from');
            const modalEmailRegNo = document.getElementById('modal-email-regno');
            const modalEmailSubject = document.getElementById('modal-email-subject');
            const modalEmailPrompt = document.getElementById('modal-email-prompt');
            const modalGenerateEmailBtn = document.getElementById('modal-generate-email-btn');
            const modalEmailBody = document.getElementById('modal-email-body');
            const modalEmailLoader = document.getElementById('modal-email-loader');
            const copyEmailBtn = document.getElementById('copy-email-btn');
            const copyConfirm = document.getElementById('copy-confirm');
            const sendEmailBtn = document.getElementById('send-email-btn');
            
            const openEmailModal = (facultyName, facultyEmail) => {
                modalEmailToDisplay.textContent = `${facultyName} <${facultyEmail}>`;
                modalEmailToValue.value = facultyEmail; // Storing for mailto
                modalEmailFrom.value = '';
                modalEmailRegNo.value = '';
                modalEmailSubject.value = '';
                modalEmailPrompt.value = '';
                modalEmailBody.value = '';
                modalEmailLoader.classList.add('hidden');
                modalGenerateEmailBtn.disabled = false;
                copyConfirm.classList.add('hidden');
                emailModal.classList.remove('hidden');
                emailModal.classList.add('active');
            };

            const closeEmailModal = () => {
                emailModal.classList.remove('active');
                setTimeout(() => {
                    emailModal.classList.add('hidden');
                }, 200); // match transition duration
            };

            document.querySelector('#faculty .grid').addEventListener('click', (e) => {
                const button = e.target.closest('.compose-email-btn');
                if (button) {
                    const facultyName = button.dataset.facultyName;
                    const facultyEmail = button.dataset.facultyEmail;
                    openEmailModal(facultyName, facultyEmail);
                }
            });
            
            closeModalBtn.addEventListener('click', closeEmailModal);
            emailModal.addEventListener('click', (e) => {
                if (e.target === emailModal) {
                    closeEmailModal();
                }
            });

            modalGenerateEmailBtn.addEventListener('click', async () => {
                const recipientName = modalEmailToDisplay.textContent.split('<')[0].trim();
                const fromName = modalEmailFrom.value.trim();
                const regNo = modalEmailRegNo.value.trim();
                const subject = modalEmailSubject.value.trim();
                const prompt = modalEmailPrompt.value.trim();

                if (!recipientName || !fromName || !regNo || !subject || !prompt) {
                    modalEmailBody.value = "Please fill in all fields (Your Name, Registration No., Subject and Prompt) before generating the email.";
                    return;
                }

                // Save the user's name and reg no for next time
                localStorage.setItem('userName', fromName);
                localStorage.setItem('userRegNo', regNo);

                modalEmailLoader.classList.remove('hidden');
                modalGenerateEmailBtn.disabled = true;
                modalEmailBody.value = "";

                const fullPrompt = `Recipient: ${recipientName}. Subject: "${subject}". Core message/request from student: "${prompt}". My name is ${fromName} and my registration number is ${regNo}.`;
                const systemPrompt = `You are an AI assistant helping a first-year engineering student ('${fromName}') draft a professional and respectful email to their professor. Given the recipient's name, the subject, and the core message, write a complete email body. Start with a polite salutation (e.g., 'Dear Prof. [Name],'), write the body based on the student's prompt, and end with a professional closing (e.g., 'Sincerely,', 'Best regards,'). The closing should be followed by the student's name on one line, and their registration number on the next line. The tone should be formal yet courteous. For example, the closing should look like:\n\nBest regards,\n${fromName}\nReg. No.: ${regNo}`;

                const aiResponse = await callGeminiAPI(fullPrompt, systemPrompt);

                modalEmailBody.value = aiResponse;
                modalEmailLoader.classList.add('hidden');
                modalGenerateEmailBtn.disabled = false;
            });
            
            copyEmailBtn.addEventListener('click', () => {
                if(modalEmailBody.value) {
                    // Use a temporary textarea to copy text to support all browsers and environments.
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = modalEmailBody.value;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextArea);

                    copyConfirm.classList.remove('hidden');
                    setTimeout(() => {
                       copyConfirm.classList.add('hidden');
                    }, 2000);
                }
            });

            sendEmailBtn.addEventListener('click', () => {
                const email = modalEmailToValue.value;
                const subject = modalEmailSubject.value;
                const body = modalEmailBody.value;

                if (!email || !body) {
                    return; // Do nothing if there's no recipient or body
                }

                const encodedSubject = encodeURIComponent(subject);
                const encodedBody = encodeURIComponent(body);

                const mailtoLink = `mailto:${email}?subject=${encodedSubject}&body=${encodedBody}`;
                
                // This opens the default email client
                window.location.href = mailtoLink;
            });


            // Initial Renders
            renderDeadlineCards();
            renderFacultyCards();
            renderRestaurantCards();
            renderAnnouncements();
        });
    </script>
</body>
</html>














